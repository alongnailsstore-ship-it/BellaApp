<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BellaLink.App.ViewModels.PartnerViewModels"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             x:Class="BellaLink.App.Views.PartnerViews.PartnerAppointmentsPage"
             Title="Minha Agenda"
             BackgroundColor="#F9F9F9"
             Shell.NavBarIsVisible="False">

    <Grid>
        <Grid RowDefinitions="Auto, *">
            <Grid BackgroundColor="White" Padding="20" HeightRequest="80" ColumnDefinitions="*, Auto">
                <Label Text="GestÃ£o de Agenda" FontSize="20" FontAttributes="Bold" TextColor="#333" VerticalOptions="Center"/>
                <Button Grid.Column="1" Text="Agendar" Command="{Binding OpenBookingModalCommand}" 
                        HeightRequest="40" CornerRadius="8" Padding="15,0" 
                        FontSize="14" FontAttributes="Bold"
                        BackgroundColor="#FF4081" TextColor="White"/>
            </Grid>

            <ScrollView Grid.Row="1" Padding="20">
                <VerticalStackLayout Spacing="25">

                    <Border StrokeThickness="0" BackgroundColor="White" StrokeShape="RoundRectangle 12" Padding="15">
                        <VerticalStackLayout Spacing="15">
                            <Label Text="âš™ï¸ HorÃ¡rio de Funcionamento" FontAttributes="Bold" TextColor="#333"/>
                            <Grid ColumnDefinitions="*, *, Auto">
                                <Border Grid.Column="0" Stroke="#EEE" HeightRequest="45" Padding="10,0" Margin="0,0,5,0">
                                    <Entry Text="{Binding WorkStart}" Placeholder="09:00" TextColor="#333"/>
                                </Border>
                                <Border Grid.Column="1" Stroke="#EEE" HeightRequest="45" Padding="10,0" Margin="5,0,0,0">
                                    <Entry Text="{Binding WorkEnd}" Placeholder="18:00" TextColor="#333"/>
                                </Border>
                                <Button Grid.Column="2" Text="Salvar" Command="{Binding SaveSettingsCommand}" 
                                        HeightRequest="45" Margin="10,0,0,0" FontSize="12" BackgroundColor="#4CAF50"/>
                            </Grid>

                            <BoxView HeightRequest="1" Color="#EEE"/>

                            <Label Text="Dias de Trabalho" FontSize="12" TextColor="#666" FontAttributes="Bold"/>
                            <Grid ColumnDefinitions="*, *">
                                <VerticalStackLayout Grid.Column="0" Spacing="5">
                                    <HorizontalStackLayout>
                                        <CheckBox IsChecked="{Binding WorkSeg}" Color="#FF4081"/>
                                        <Label Text="Segunda" VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                    <HorizontalStackLayout>
                                        <CheckBox IsChecked="{Binding WorkTer}" Color="#FF4081"/>
                                        <Label Text="TerÃ§a" VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                    <HorizontalStackLayout>
                                        <CheckBox IsChecked="{Binding WorkQua}" Color="#FF4081"/>
                                        <Label Text="Quarta" VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                    <HorizontalStackLayout>
                                        <CheckBox IsChecked="{Binding WorkQui}" Color="#FF4081"/>
                                        <Label Text="Quinta" VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                                <VerticalStackLayout Grid.Column="1" Spacing="5">
                                    <HorizontalStackLayout>
                                        <CheckBox IsChecked="{Binding WorkSex}" Color="#FF4081"/>
                                        <Label Text="Sexta" VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                    <HorizontalStackLayout>
                                        <CheckBox IsChecked="{Binding WorkSab}" Color="#FF4081"/>
                                        <Label Text="SÃ¡bado" VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                    <HorizontalStackLayout>
                                        <CheckBox IsChecked="{Binding WorkDom}" Color="#FF4081"/>
                                        <Label Text="Domingo" VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                    <HorizontalStackLayout>
                                        <CheckBox IsChecked="{Binding WorkHoliday}" Color="#9C27B0"/>
                                        <Label Text="Feriados" VerticalOptions="Center" TextColor="#9C27B0"/>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                    <VerticalStackLayout Spacing="10">
                        <Label Text="ðŸ”” SolicitaÃ§Ãµes Pendentes" FontAttributes="Bold" TextColor="#FF9800" FontSize="16"/>

                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding PendingAppointments}" Spacing="10">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate>
                                    <Border BackgroundColor="White" StrokeThickness="0" StrokeShape="RoundRectangle 10" Padding="15">
                                        <VerticalStackLayout Spacing="10">
                                            <Grid ColumnDefinitions="*, Auto">
                                                <VerticalStackLayout>
                                                    <Label Text="{Binding ClientName, StringFormat='Cliente: {0}'}" FontAttributes="Bold" TextColor="#333"/>
                                                    <Label Text="{Binding ServiceName}" TextColor="#666" FontSize="12"/>
                                                    <Label Text="{Binding Date, StringFormat='{0:dd/MM - HH:mm}'}" TextColor="#FF4081" FontAttributes="Bold"/>
                                                </VerticalStackLayout>
                                                <Label Grid.Column="1" Text="{Binding Price, StringFormat='R$ {0:F2}'}" FontAttributes="Bold" TextColor="#333"/>
                                            </Grid>
                                            <Grid ColumnDefinitions="*, *" ColumnSpacing="10">
                                                <Button Grid.Column="0" Text="Recusar" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PartnerAppointmentsViewModel}}, Path=DenyCommand}" CommandParameter="{Binding .}"
                                                        BackgroundColor="#FFEBEE" TextColor="#D32F2F" HeightRequest="35" FontSize="12" Padding="0"/>
                                                <Button Grid.Column="1" Text="Aceitar" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PartnerAppointmentsViewModel}}, Path=AcceptCommand}" CommandParameter="{Binding .}"
                                                        BackgroundColor="#E8F5E9" TextColor="#2E7D32" HeightRequest="35" FontSize="12" Padding="0"/>
                                            </Grid>
                                        </VerticalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                    </VerticalStackLayout>

                    <VerticalStackLayout Spacing="10">
                        <Label Text="âœ… Agenda Confirmada" FontAttributes="Bold" TextColor="#2E7D32" FontSize="16"/>

                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding ConfirmedAppointments}" Spacing="12">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate>
                                    <Border BackgroundColor="White" StrokeThickness="0" StrokeShape="RoundRectangle 12">
                                        <Border.Shadow>
                                            <Shadow Brush="Black" Offset="0,2" Opacity="0.05"/>
                                        </Border.Shadow>

                                        <Grid RowDefinitions="Auto, Auto">
                                            <Grid ColumnDefinitions="5, 70, *, Auto">
                                                <BoxView Grid.Column="0" Color="#4CAF50" WidthRequest="5" VerticalOptions="Fill"/>

                                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="0" BackgroundColor="#F9F9F9" Padding="10">
                                                    <Label Text="{Binding Date, StringFormat='{0:ddd}'}" FontSize="10" TextColor="#4CAF50" HorizontalOptions="Center" TextTransform="Uppercase"/>
                                                    <Label Text="{Binding Date, StringFormat='{0:dd}'}" FontSize="20" FontAttributes="Bold" TextColor="#4CAF50" HorizontalOptions="Center"/>
                                                    <Label Text="{Binding Date, StringFormat='{0:MMM}'}" FontSize="10" TextColor="#4CAF50" HorizontalOptions="Center" TextTransform="Uppercase"/>
                                                </VerticalStackLayout>

                                                <VerticalStackLayout Grid.Column="2" Padding="12,10" Spacing="3" VerticalOptions="Center">
                                                    <Label Text="{Binding ClientName}" FontAttributes="Bold" TextColor="#333" FontSize="15" LineBreakMode="TailTruncation"/>
                                                    <Label Text="{Binding ServiceName}" TextColor="#666" FontSize="13"/>
                                                    <Label Text="{Binding Date, StringFormat='â° {0:HH:mm}'}" TextColor="#999" FontSize="12"/>
                                                </VerticalStackLayout>

                                                <Label Grid.Column="3" Text="{Binding Price, StringFormat='R$ {0:F0}'}" VerticalOptions="Center" TextColor="#333" FontAttributes="Bold" Margin="0,0,15,0"/>
                                            </Grid>

                                            <Grid Grid.Row="1" ColumnDefinitions="*, *" Margin="10,0,10,10" ColumnSpacing="10">
                                                <Button Grid.Column="0" Text="Excluir" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PartnerAppointmentsViewModel}}, Path=CancelConfirmedCommand}" CommandParameter="{Binding .}"
                                                        BackgroundColor="#FFEBEE" TextColor="#D32F2F" HeightRequest="30" FontSize="11" Padding="0"/>
                                                <Button Grid.Column="1" Text="Remarcar" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PartnerAppointmentsViewModel}}, Path=RescheduleCommand}" CommandParameter="{Binding .}"
                                                        BackgroundColor="#E3F2FD" TextColor="#1976D2" HeightRequest="30" FontSize="11" Padding="0"/>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                    </VerticalStackLayout>

                </VerticalStackLayout>
            </ScrollView>
        </Grid>

        <Grid BackgroundColor="#90000000" IsVisible="{Binding IsBookingModalVisible}">
            <Border BackgroundColor="White" StrokeShape="RoundRectangle 15" WidthRequest="320" VerticalOptions="Center" Padding="20">
                <VerticalStackLayout Spacing="15">
                    <Label Text="{Binding ModalTitle}" FontSize="18" FontAttributes="Bold" TextColor="#333" HorizontalOptions="Center"/>

                    <VerticalStackLayout>
                        <Label Text="Telefone do Cliente" FontSize="12" TextColor="#666"/>
                        <Border Stroke="#DDD" StrokeShape="RoundRectangle 8" HeightRequest="45" Padding="10,0">
                            <Entry Placeholder="Digite o nÃºmero" Text="{Binding ManualPhoneInput}" Keyboard="Telephone" TextColor="#333" MaxLength="15" TextChanged="OnPhoneChanged"/>
                        </Border>
                    </VerticalStackLayout>

                    <Label Text="ServiÃ§o" FontSize="12" TextColor="#666"/>
                    <Border Stroke="#DDD" StrokeShape="RoundRectangle 8" HeightRequest="45" Padding="10,0">
                        <Picker Title="Selecione..." ItemsSource="{Binding MyServices}" ItemDisplayBinding="{Binding Name}" SelectedItem="{Binding SelectedManualService}" TextColor="#333"/>
                    </Border>

                    <Grid ColumnDefinitions="*, *" ColumnSpacing="10">
                        <VerticalStackLayout>
                            <Label Text="Data" FontSize="12" TextColor="#666"/>
                            <DatePicker Date="{Binding ManualDate}" MinimumDate="{x:Static sys:DateTime.Today}" TextColor="#333"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1">
                            <Label Text="Hora" FontSize="12" TextColor="#666"/>
                            <TimePicker Time="{Binding ManualTime}" TextColor="#333"/>
                        </VerticalStackLayout>
                    </Grid>

                    <Grid ColumnDefinitions="*, *" ColumnSpacing="10" Margin="0,10,0,0">
                        <Button Grid.Column="0" Text="Cancelar" Command="{Binding CloseBookingModalCommand}" BackgroundColor="#F0F0F0" TextColor="#333"/>
                        <Button Grid.Column="1" Text="Confirmar" Command="{Binding ConfirmManualAppointmentCommand}" BackgroundColor="#FF4081" TextColor="White" FontAttributes="Bold"/>
                    </Grid>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <ActivityIndicator IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}" Color="#FF4081" VerticalOptions="Center" HorizontalOptions="Center"/>
    </Grid>
</ContentPage>
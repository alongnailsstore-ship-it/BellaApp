<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BellaLink.App.ViewModels.ConsumerViewModels"
             xmlns:converters="clr-namespace:BellaLink.App.Converters"
             x:Class="BellaLink.App.Views.ConsumerViews.ConsumerHomePage"
             Title="BellaLink"
             BackgroundColor="#FAFAFA"
             Shell.NavBarIsVisible="False">

    <ContentPage.Resources>
        <converters:BoolToOpenStatusConverter x:Key="BoolToOpenStatusConverter"/>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *">

        <Grid ColumnDefinitions="*, Auto, Auto" Padding="20,10" BackgroundColor="White">
            <VerticalStackLayout Spacing="0" VerticalOptions="Center">
                <Label Text="OlÃ¡," TextColor="#999" FontSize="14"/>
                <Label Text="{Binding UserName}" TextColor="#FF4081" FontSize="20" FontAttributes="Bold"/>
            </VerticalStackLayout>

            <ImageButton Grid.Column="1" 
                         Source="{FontImageSource Glyph='ðŸ”', Color='#333', Size=22}"
                         BackgroundColor="Transparent"
                         HeightRequest="40" WidthRequest="40"
                         Margin="0,0,10,0"
                         Command="{Binding GoToSearchCommand}"/>

            <Border Grid.Column="2" StrokeShape="RoundRectangle 20" HeightRequest="40" WidthRequest="40" StrokeThickness="0">
                <Image Source="{Binding UserPhoto, TargetNullValue='https://ui-avatars.com/api/?name=U'}" Aspect="AspectFill"/>
                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding GoToProfileCommand}"/>
                </Border.GestureRecognizers>
            </Border>
        </Grid>

        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="20" Padding="0,0,0,20">

                <Grid HeightRequest="180" Margin="0,10,0,0">

                    <CarouselView ItemsSource="{Binding Banners}" 
                                  Position="{Binding CurrentBannerPosition}"
                                  Loop="False"
                                  IndicatorView="indicatorView">
                        <CarouselView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="15,0">
                                    <Border StrokeShape="RoundRectangle 15" StrokeThickness="0">
                                        <Grid>
                                            <Image Source="{Binding ImageUrl}" Aspect="AspectFill"/>
                                            <BoxView VerticalOptions="End" HeightRequest="60" Color="#99000000"/>
                                            <Label Text="{Binding Title}" 
                                                   TextColor="White" 
                                                   FontAttributes="Bold" 
                                                   FontSize="16"
                                                   VerticalOptions="End" 
                                                   Margin="15"/>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </CarouselView.ItemTemplate>
                    </CarouselView>

                    <Border BackgroundColor="#80000000" StrokeShape="RoundRectangle 15" 
                            HeightRequest="30" WidthRequest="30" 
                            HorizontalOptions="Start" VerticalOptions="Center" 
                            Margin="25,0,0,0" StrokeThickness="0">
                        <Label Text="â®" TextColor="White" FontSize="14" FontAttributes="Bold" 
                               HorizontalOptions="Center" VerticalOptions="Center"/>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding PreviousBannerCommand}"/>
                        </Border.GestureRecognizers>
                    </Border>

                    <Border BackgroundColor="#80000000" StrokeShape="RoundRectangle 15" 
                            HeightRequest="30" WidthRequest="30" 
                            HorizontalOptions="End" VerticalOptions="Center" 
                            Margin="0,0,25,0" StrokeThickness="0">
                        <Label Text="â¯" TextColor="White" FontSize="14" FontAttributes="Bold" 
                               HorizontalOptions="Center" VerticalOptions="Center"/>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NextBannerCommand}"/>
                        </Border.GestureRecognizers>
                    </Border>

                    <IndicatorView x:Name="indicatorView"
                                   IndicatorColor="LightGray"
                                   SelectedIndicatorColor="#FF4081"
                                   HorizontalOptions="Center"
                                   VerticalOptions="End"
                                   Margin="0,0,0,10"/>
                </Grid>

                <Border Margin="20,0" Stroke="#E0E0E0" StrokeShape="RoundRectangle 10" BackgroundColor="White" Padding="10,0" HeightRequest="50">
                    <Grid ColumnDefinitions="Auto, *">
                        <Label Text="ðŸ”" VerticalOptions="Center" TextColor="#999" Margin="5,0"/>
                        <Entry Grid.Column="1" 
                               Placeholder="Buscar salÃ£o, serviÃ§o..." 
                               Text="{Binding SearchText}"
                               TextColor="#333"
                               VerticalOptions="Center"/>
                    </Grid>
                </Border>

                <VerticalStackLayout Spacing="10" Padding="20,0">
                    <Label Text="Recomendados para vocÃª" FontAttributes="Bold" FontSize="16" TextColor="#333"/>

                    <CollectionView ItemsSource="{Binding Partners}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border StrokeShape="RoundRectangle 15" StrokeThickness="0" BackgroundColor="White" Margin="0,0,0,15" Padding="10">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ConsumerHomeViewModel}}, Path=SelectPartnerCommand}" CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>

                                    <Grid ColumnDefinitions="80, *">
                                        <Border StrokeShape="RoundRectangle 10" HeightRequest="80" WidthRequest="80" StrokeThickness="0">
                                            <Image Source="{Binding ImageUrl}" Aspect="AspectFill"/>
                                        </Border>

                                        <VerticalStackLayout Grid.Column="1" Margin="10,0,0,0" Spacing="5" VerticalOptions="Center">
                                            <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="16" TextColor="#333"/>
                                            <Label Text="{Binding Category}" FontSize="12" TextColor="#999"/>

                                            <HorizontalStackLayout Spacing="10">
                                                <Label Text="{Binding Rating, StringFormat='â˜… {0:F1}'}" TextColor="#FFD700" FontSize="12" FontAttributes="Bold"/>
                                                <Label Text="{Binding IsOpen, Converter={StaticResource BoolToOpenStatusConverter}}" TextColor="#4CAF50" FontSize="12"/>
                                            </HorizontalStackLayout>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>

        <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" 
                           Color="#FF4081" HorizontalOptions="Center" VerticalOptions="Center" Grid.RowSpan="2"/>
    </Grid>
</ContentPage>